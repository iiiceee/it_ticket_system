<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î IT</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.comment-bubble {
  max-width: 60%;
  padding: 10px 15px;
  margin: 5px 0;
  border-radius: 15px;
  position: relative;
  display: inline-block;
  font-size: 0.9em;
  line-height: 1.4em;
}

.comment-bubble.left {
  background-color: #f0f0f0;
  margin-left: 0;
  text-align: left;
}

.comment-bubble.right {
  background-color: #d1f3ff;
  margin-left: auto;
  text-align: right;
}
.comment-meta {
  font-size: 0.7em;
  color: #888;
  margin-top: 3px;
}
.comment-wrap {
  display: flex;
  flex-direction: column;
  margin-top: 10px;
}


</style>


<style>
.ticket-done {
  background-color: #e0ffe0; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô (‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß) */
}
.ticket-processing {
  background-color: #ffe4ec; /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô (‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) */
}
</style>

</head>
<body>
<h2>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏° IT</h2>

<p>üìÖ ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: {{ weekly }} ‡∏á‡∏≤‡∏ô</p>
<p>üóìÔ∏è ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {{ monthly }} ‡∏á‡∏≤‡∏ô</p>
<p>üìà ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: {{ yearly }} ‡∏á‡∏≤‡∏ô</p>
<p>üìå ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà: {{ pending }}</p>
<p>üõ†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: {{ processing }}</p>

<hr>
<p><a href="{{ url_for('index') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></p>
<p>
  <a href="{{ url_for('download_excel') }}">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel</a>
</p>


<div style="margin: 20px 0;">
  <p><a href="{{ url_for('download_db') }}" class="btn btn-success">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a></p>

  <form action="{{ url_for('upload_db') }}" method="POST" enctype="multipart/form-data" style="display: inline-block;">
    <input type="file" name="db_file" accept=".db" required>
    <button type="submit" class="btn btn-warning">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </form>
</div>



<div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
  {% if tickets.has_prev %}
    <a href="{{ url_for('dashboard', page=tickets.prev_num) }}">&laquo; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
  {% endif %}

  {% for p in range(start_page, end_page + 1) %}
    {% if p == tickets.page %}
      <strong style="padding: 5px 10px; background-color: #007bff; color: white; border-radius: 5px;">{{ p }}</strong>
    {% else %}
      <a href="{{ url_for('dashboard', page=p) }}" style="padding: 5px 10px; background-color: #eee; border-radius: 5px; text-decoration: none;">{{ p }}</a>
    {% endif %}
  {% endfor %}

  {% if tickets.has_next %}
    <a href="{{ url_for('dashboard', page=tickets.next_num) }}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &raquo;</a>
  {% endif %}
</div>
<table style="width: 100%; table-layout: fixed; border-collapse: collapse;">
  <tr>
        <th>‡∏ú‡∏π‡πâ‡πÄ‡∏õ‡∏¥‡∏î</th>
    <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
    <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
    <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
    <th>‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö</th> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ -->
    <th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå</th>
  </tr>

  {% for ticket in tickets %}
<tr class="{% if ticket.status == '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' %}ticket-done{% elif ticket.status == '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' %}ticket-processing{% endif %}">

  <td>{{ ticket.user.username }}</td>
  <td>{{ ticket.title }}</td>
  <td>{{ ticket.description }}</td>
  <td>
    {{ ticket.status }}
    {% if ticket.status != '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' %}
    <form method="POST" action="{{ url_for('update_status', ticket_id=ticket.id) }}" style="display:inline;">
        <select name="status">
            <option value="‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
        </select><br>
        <textarea name="comment" rows="2" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea><br>
        <button type="submit">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
    </form>
    {% endif %}
  </td>
  <td>{{ ticket.created_at.strftime('%Y-%m-%d') }}</td>
  <td>{{ ticket.updated_at.strftime('%Y-%m-%d') }}</td>
  <td>
    {% if ticket.image1 or ticket.image2 or ticket.image3 %}
    <div style="display: flex; gap: 5px;">
      {% for img in [ticket.image1, ticket.image2, ticket.image3] if img %}
        <a href="{{ url_for('static', filename=img) }}" target="_blank">
          <img src="{{ url_for('static', filename=img) }}" width="150" style="border: 1px solid #ccc; border-radius: 5px;">
        </a>
      {% endfor %}
    </div>
    {% else %}
      <span style="color: gray;">‚Äì</span>
    {% endif %}
  </td>
  <td> <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ table ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô -->
    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏î‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á" -->
    <span style="font-size: 0.8em; color: gray;">‡∏î‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</span>
  </td>
</tr>

<!-- üîΩ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô bubble ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà -->
<tr>
  <td colspan="7">
    <div class="comment-wrap">
      {% for comment in comments_by_ticket[ticket.id] %}
        <div class="comment-bubble {% if comment.user_id == session['user_id'] %}right{% else %}left{% endif %}">
          <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
          <div class="comment-meta">
            {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
          </div>
        </div>
      {% else %}
        <div style="color:gray;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</div>
      {% endfor %}
    </div>
  </td>
</tr>
{% endfor %}

</table>


<div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
  {% if tickets.has_prev %}
    <a href="{{ url_for('dashboard', page=tickets.prev_num) }}">&laquo; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
  {% endif %}

  {% for p in range(start_page, end_page + 1) %}
    {% if p == tickets.page %}
      <strong style="padding: 5px 10px; background-color: #007bff; color: white; border-radius: 5px;">{{ p }}</strong>
    {% else %}
      <a href="{{ url_for('dashboard', page=p) }}" style="padding: 5px 10px; background-color: #eee; border-radius: 5px; text-decoration: none;">{{ p }}</a>
    {% endif %}
  {% endfor %}

  {% if tickets.has_next %}
    <a href="{{ url_for('dashboard', page=tickets.next_num) }}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &raquo;</a>
  {% endif %}
</div>

<h3 style="margin-top: 40px;">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏µ 2025)</h3>
<canvas id="monthlyChart" width="400" height="150"></canvas>

<p><a href="{{ url_for('index') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></p>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const ctx = document.getElementById('monthlyChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ months | safe }},
      datasets: [
        {
          label: '‡πÉ‡∏´‡∏°‡πà',
          data: {{ new_counts | safe }},
          backgroundColor: '#ffb3c1'
        },
        {
          label: '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
          data: {{ processing_counts | safe }},
          backgroundColor: '#add8e6'
        },
        {
          label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
          data: {{ done_counts | safe }},
          backgroundColor: '#c4f1c4'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
});
</script>


</body>
</html>
